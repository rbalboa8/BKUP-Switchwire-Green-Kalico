[respond]

[gcode_macro SET_CONTROLLER_FAN_CONFIG]
description: Sets the parameters for the custom controller fan logic.
gcode:
  {% set temp = params.TEMP|default(50)|float %}
  {% set timeout = params.TIMEOUT|default(30)|int %}
  {% set speed = params.SPEED|default(1.0)|float %}

  SAVE_VARIABLE VARIABLE=mcu_temp_threshold VALUE={temp}
  SAVE_VARIABLE VARIABLE=stepper_idle_timeout VALUE={timeout}
  SAVE_VARIABLE VARIABLE=fan_speed VALUE={speed}
  
  {action_respond_info("Controller Fan Config Updated:
    TEMP_THRESHOLD: %.1f C
    IDLE_TIMEOUT: %d s
    FAN_SPEED: %.2f (Note: max_power is %.2f)" % (temp, timeout, speed, printer.configfile.settings['fan_generic electronics_fan'].max_power|float))}

[delayed_gcode _CONTROLLER_FAN_LOOP]
initial_duration: 1.0
gcode:
  _CHECK_CONTROLLER_FAN
  UPDATE_DELAYED_GCODE ID=_CONTROLLER_FAN_LOOP DURATION=1

[gcode_macro _CHECK_CONTROLLER_FAN]
variable_is_cooling: False
gcode:
  # --- Load States ---
  {% set mcu_temp = printer["temperature_sensor mcu_temp"].temperature %}
  {% set mcu_is_hot = mcu_temp > printer.save_variables.variables.mcu_temp_threshold|default(50)|float %}
  
  {% set s_x = printer.stepper_enable.steppers['stepper_x'] %}
  {% set s_y = printer.stepper_enable.steppers['stepper_y'] %}
  {% set s_z = printer.stepper_enable.steppers['stepper_z'] %}
  {% set s_e = printer.stepper_enable.steppers['extruder'] %}
  {% set steppers_on = s_x or s_y or s_z or s_e %}

  # --- Load our flag variable using the FULL, CORRECT syntax ---
  {% set cooling_flag = printer.is_cooling %}
  
  {% set fan_speed = printer["fan_generic electronics_fan"].speed %}
  
  # --- DEBUG: Print all states to console ---
  {action_respond_info("FAN DEBUG: SteppersOn=%s, MCUHot=%s, CoolingFlag=%s, FanSpeed=%.2f" % (steppers_on, mcu_is_hot, cooling_flag, fan_speed))}

  # --- The "OR" Logic ---
  {% if steppers_on or mcu_is_hot %}
      {action_respond_info("--- LOGIC: ON condition met.")}
      SET_GCODE_VARIABLE MACRO=_CHECK_CONTROLLER_FAN VARIABLE=is_cooling VALUE={False}
      SET_FAN_SPEED FAN=electronics_fan SPEED={printer.save_variables.variables.fan_speed|default(1.0)|float}
      UPDATE_DELAYED_GCODE ID=_CONTROLLER_FAN_OFF_TIMER DURATION=0
  
  {% else %}
      # --- OFF-CONDITION: Steppers are off AND MCU is cool. ---
      {action_respond_info("--- LOGIC: OFF condition met.")}
      
      {% if fan_speed > 0 %}
          {action_respond_info("......Fan is ON.")}
          {% if not cooling_flag %}
              {action_respond_info("......Cooling flag is FALSE. Setting 30s timer NOW.")}
              SET_GCODE_VARIABLE MACRO=_CHECK_CONTROLLER_FAN VARIABLE=is_cooling VALUE={True}
              UPDATE_DELAYED_GCODE ID=_CONTROLLER_FAN_OFF_TIMER DURATION={printer.save_variables.variables.stepper_idle_timeout|default(30)|int}
          {% else %}
              {action_respond_info("......Cooling flag is TRUE. Timer is already pending. Doing nothing.")}
          {% endif %}
      {% else %}
          {action_respond_info("......Fan is OFF. Doing nothing.")}
      {% endif %}
  {% endif %}

[delayed_gcode _CONTROLLER_FAN_OFF_TIMER]
gcode:
  {action_respond_info("!!! TIMER_OFF: 30s timer complete. Turning fan OFF and resetting flag.!!!")}
  SET_FAN_SPEED FAN=electronics_fan SPEED=0.0
  SET_GCODE_VARIABLE MACRO=_CHECK_CONTROLLER_FAN VARIABLE=is_cooling VALUE={False}









